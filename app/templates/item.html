{% extends "base.html" %}

{% block title %}Questão - OAZ IA Profiler{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto" x-data="itemForm()">
    <div class="mb-6">
        <div class="bg-gray-200 rounded-full h-2">
            <div class="bg-blue-600 h-2 rounded-full transition-all" style="width: {{ progress.percentage }}%"></div>
        </div>
        <p class="text-sm text-gray-600 mt-2 text-center">
            Questão {{ progress.current }} de {{ progress.total }}
        </p>
    </div>

    <div class="bg-white rounded-lg shadow-md p-8">
        <div class="mb-6">
            {% if item.block %}
            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full mb-4">
                {{ item.block }}
            </span>
            {% elif item.competency %}
            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full mb-4">
                {{ item.competency }}
            </span>
            {% endif %}
            <p class="text-lg text-gray-900 leading-relaxed">
                {{ item.stem }}
            </p>
        </div>

        {% if item.type in ['mcq', 'scenario', 'matrix'] %}
        <div class="space-y-3 mb-6">
            {% for choice in item.choices %}
            <label class="flex items-start p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 cursor-pointer transition-all group">
                <input 
                    type="radio" 
                    name="answer" 
                    value="{{ loop.index0 | chr }}"
                    x-model="answer"
                    class="mt-1 w-4 h-4 text-blue-600 focus:ring-blue-500"
                >
                <span class="ml-3 text-gray-700 group-hover:text-gray-900">
                    <strong class="text-blue-600">{{ loop.index0 | chr }}.</strong> {{ choice }}
                </span>
            </label>
            {% endfor %}
        </div>
        {% else %}
        <div class="mb-6">
            <textarea 
                x-model="answer"
                rows="6"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="Digite sua resposta aqui..."
            ></textarea>
        </div>
        {% endif %}

        <div x-show="error" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-800" x-text="error"></p>
        </div>

        <div class="flex justify-between items-center">
            <button 
                @click="skipQuestion"
                class="text-gray-600 hover:text-gray-800 text-sm"
            >
                Pular questão
            </button>
            
            <button 
                @click="submitAnswer"
                :disabled="loading || !answer"
                class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
            >
                <span x-show="!loading">Próxima</span>
                <span x-show="loading">Processando...</span>
            </button>
        </div>
    </div>
</div>

<script>
function itemForm() {
    return {
        answer: '',
        loading: false,
        error: '',
        startTime: Date.now(),
        
        async submitAnswer() {
            if (!this.answer) {
                this.error = 'Por favor, selecione ou escreva uma resposta';
                return;
            }
            
            this.error = '';
            this.loading = true;
            
            const latency = Date.now() - this.startTime;
            
            try {
                const response = await fetch('/responses/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        item_id: {{ item.id }},
                        answer: this.answer,
                        latency_ms: latency
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.should_stop) {
                        window.location.href = '/items/finish-page';
                    } else {
                        window.location.href = '/items/next';
                    }
                } else {
                    this.error = data.error || 'Erro ao processar resposta';
                    this.loading = false;
                }
            } catch (err) {
                this.error = 'Erro de conexão. Tente novamente.';
                this.loading = false;
            }
        },
        
        skipQuestion() {
            this.answer = 'SKIP';
            this.submitAnswer();
        }
    }
}
</script>
{% endblock %}
